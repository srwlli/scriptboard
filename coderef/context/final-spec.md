Below is a **fully consolidated, integrated, agent-ready specification** that merges:

* **All 12 improvement items you listed**
* **The full architecture migration plan (Tk â†’ Python Core + FastAPI + Next + Electron)**
* **A canonical feature list with MVP vs Phase-2 scope**
* **Clear state ownership, API contracts, security, autosave rules, Git, batch, Direct API semantics, testing, packaging, and migration guidance**

This is written **as a single authoritative spec** a development agent can execute without needing any of our prior conversation.

---

# âœ… **SCRIPTBOARD â€” FINAL CONSOLIDATED SPECIFICATION (FOR AGENT IMPLEMENTATION)**

### *Desktop App (Electron) + Local Backend (FastAPI) + UI (Next.js) + Core Engine (Python)*

### *Includes all 12 structural improvements*

---

# 1. **Canonical Feature List (MVP vs Phase-2)**

> **Every feature number below is now authoritative.**
> No other numbering is valid. All references use this list.

### **MVP Features**

1. **Prompt Management** (load, paste, clear, view)
2. **Attachment Handling** (files, clipboard)
3. **Response Collection** (paste, view, clear)
4. **Unified Preview Panel**
5. **Favorites Management**
6. **Session Save/Load (JSON)**
7. **Autosave + Recovery Mechanism**
8. **Search Across Prompt / Attachments / Responses**
9. **Config System + Profiles + View Settings**
10. **Token Counting Engine (tiktoken or provider-specific)**
11. **Theme System (Dark/Light) with modern styling**
12. **Keyboard Shortcut System (with remapping)**

### **Phase-2 Features**

13. **Response Diff Viewer**
14. **Batch Processing Queue**
15. **Direct LLM API Mode (OpenAI/Claude/etc.)**
16. **Attachment Folder Import (recursive)**
17. **Git Integration (commit sessions)**
18. **Export to Markdown/PDF**
19. **Logging Console Panel**
20. **Workspace Profiles (favorites + layout presets)**

---

# 2. **System Architecture (Clear State Ownership)**

Your 12 improvement items demand strict separation of responsibilities.

## **2.1 Final Architecture**

| Layer                        | Responsibilities                                                                                        | MUST NOT                                                      |
| ---------------------------- | ------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- |
| **ScriptboardCore (Python)** | State owner: prompt, attachments, responses, batch queue, token counts. Pure business logic.            | Touch UI, HTTP, Electron APIs.                                |
| **FastAPI Backend**          | API surface, request validation, error model, session save/load, autosave, filesystem access (guarded). | Store long-term state outside Core. Duplicate business logic. |
| **Next.js Frontend**         | Display + interaction, theme, diff view, search UI. Delegates all state changes to backend.             | Maintain authoritative state, run LLM calls, read/write disk. |
| **Electron**                 | Launch backend, file dialogs, IPC for folder selection, enforce local-only trust model, package app.    | Perform any business logic or state mutation.                 |

---

# 3. **Config, Profiles, Sessions â€” Final Unified Model**

## **3.1 Config (`~/.scriptboard/config.json`)**

Contains:

* default favorites
* default view toggles
* keyboard remapping
* theme preference
* Direct API provider settings (NO KEYS)

Must validate using a JSON schema.
Invalid config â†’ fallback to autogenerated safe default.

## **3.2 Profiles**

Profiles are named presets stored inside `config.json`.

A profile modifies UI/behavior defaults, NOT session content.
Loading a profile **never** overwrites active session text.

## **3.3 Sessions**

Saved as JSON files under:

```
{user_data_dir}/scriptboard/sessions/<timestamp>.json
```

Sessions contain:

* prompt
* attachments (base64 only for binaries; text inline)
* responses
* active profile name
* schema_version

## **3.4 Autosave**

* File: `autosave.json`
* Debounce: **1s** after last state mutation
* Should not exceed 2MB or it rotates to `autosave.old.json`

---

# 4. **API Contracts (Schemas, IDs, Errors, Search Semantics)**

## **4.1 ID Rules**

* Attachments: `att_<uuid4>`
* Responses: `resp_<uuid4>`
* Sessions: timestamp-based filename only

IDs must remain stable after save/load.

## **4.2 Error Envelope**

Every error must follow this format:

```json
{
  "error": {
    "code": "STRING_ENUM",
    "message": "Human-readable description",
    "details": {}
  }
}
```

Errors never return stack traces to frontend.

## **4.3 Search Semantics**

Backend search rules:

* substring match
* case-insensitive
* returns: `{ id, type, name, snippet }`
* pagination: `limit`, `offset`
* snippet includes matched region Â± 40 chars

Search never returns raw full file content.

---

# 5. **Security & Trust Model**

## **5.1 Backend binding**

Backend MUST bind to:

```
127.0.0.1
```

Never bind to `0.0.0.0`.

## **5.2 Dangerous Operations Allowed ONLY in Electron mode**

* Folder import
* File dialogs
* Writing to arbitrary filesystem paths

These must be restricted using IPC guards:

* Electron provides absolute paths
* Backend validates path exists *and is inside allowed roots*

## **5.3 Direct API Mode Security**

* API keys stored only in **OS keychain** or environment variables
* Never in config files
* Backend enforces provider quotas, failure codes, rate limiting

---

# 6. **Performance Rules (Autosave, Tokenization, Binary Handling)**

## **6.1 Large Data Protections**

* Max attachment load: 2MB
* Max full session size: 10MB
* Larger items become "reference-only" (metadata without loading text)

## **6.2 Binary Files**

Backend detects binaries:

* store metadata only
* mark `"binary": true`
* do NOT load into memory

## **6.3 Token Counting**

* cached per attachment + per response + prompt
* recalculated only when text updates

---

# 7. **Git Integration (Phase-2)**

The following rules must be implemented:

* Git commits occur only within a designated `sessions/` repo folder
* Commit message format:

  ```
  Scriptboard Session Save â€” <timestamp>
  ```
* Validate:

  * is repo clean?
  * user.name and user.email set?
  * branches safe?

If commit cannot proceed â†’ return structured error.

---

# 8. **Batch Processing & Direct API Semantics**

## **8.1 Batch Queue**

Each job:

```json
{
  "id": "batch_<uuid>",
  "prompt": "...",
  "attachments": [...],
  "model": "openai:gpt-4.1",
  "status": "pending|running|done|error",
  "result": null
}
```

Jobs do **NOT auto-run** unless Direct API mode is active.

## **8.2 Direct API**

When enabled:

* `/llm/run` executes a real LLM call
* supports streaming (optional Phase-2)
* handles token limit, API errors, timeouts

---

# 9. **Electron Lifecycle & Packaging**

## **9.1 Backend Startup**

Electron must:

1. spawn backend binary
2. poll `/health` every 200ms
3. after health success, load Next UI
4. on backend crash, show UI error + offer restart

## **9.2 Ports**

Default ports:

* Backend: `8000`
* Frontend Dev: `3000`
* Frontend Prod: static loaded inside Electron

Ports configurable via environment variables.

## **9.3 Packaging**

Final build includes:

* PyInstaller backend binary
* Next.js static export
* Electron wrapper with IPC handlers

---

# 10. **Testing & CI/CD Requirements**

## Backend Tests:

* Unit tests for Core
* API tests for all endpoints
* Session load/save tests
* Tokenization test with sample models

## Frontend Tests:

* Component tests (e.g., attachments list)
* Integration tests (React Testing Library)

## E2E Tests:

* load â†’ attach â†’ preview â†’ save â†’ reload
* diff viewer
* search

## CI:

* GitHub Actions: run backend + frontend tests on push
* Enforce 90% coverage for Core

---

# 11. **Documentation & Migration Notes**

* Full README
* Developer setup guide
* Migration from Tkinter Scriptboard
* OpenAPI auto-docs
* User onboarding modal inside UI

---

# 12. **Non-Functional Acceptance Criteria**

* App cold start < **1.0 seconds**
* Search results < **150ms** for up to 50 attachments
* Tokenization < **200ms** for 10k characters
* UI stays responsive even with:

  * 50 attachments
  * 10 responses
  * 250k total characters

---

# ðŸ”¥ **This is the integrated master specification.**

It is now complete, self-contained, and ready for agent implementation.

---

If you want, I can now generate:

### âœ… A *step-by-step agent instruction list* based entirely on this final spec

### âœ… API endpoint list with full Pydantic schemas

### âœ… Directory structure for the whole project

### âœ… Component map for the frontend

### âœ… Electron IPC contract

### âœ… ScriptboardCore class skeleton in Python

Just tell me:
**Which of these do you want generated next?**
